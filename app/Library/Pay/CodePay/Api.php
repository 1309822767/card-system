<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp5d3f49) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp5d3f49; $this->url_return = SYS_URL . '/pay/return/' . $sp5d3f49; } function goPay($spc8c9ef, $sp4510be, $sp930bb6, $sp9a31c1, $spfa6477) { $sp7918ab = sprintf('%.2f', $spfa6477 / 100); $sp9e3ad2 = $spc8c9ef['id']; $spbdce03 = $spc8c9ef['key']; switch ($spc8c9ef['payway']) { case 'alipay': $sp8f02bb = 1; break; case 'qq': $sp8f02bb = 2; break; case 'weixin': $sp8f02bb = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp69c4ce = array('id' => $sp9e3ad2, 'pay_id' => $sp4510be, 'type' => $sp8f02bb, 'price' => $sp7918ab, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp69c4ce); $sp1e1df1 = ''; $spc58c8d = ''; foreach ($sp69c4ce as $sp1e4b49 => $sp7a0550) { if ($sp7a0550 == '' || $sp1e4b49 == 'sign') { continue; } if ($sp1e1df1 != '') { $sp1e1df1 .= '&'; $spc58c8d .= '&'; } $sp1e1df1 .= "{$sp1e4b49}={$sp7a0550}"; $spc58c8d .= "{$sp1e4b49}=" . urlencode($sp7a0550); } $sp7a245d = $spc58c8d . '&sign=' . md5($sp1e1df1 . $spbdce03); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp7a245d); die; } function verify($spc8c9ef, $sp53cf01) { $sp412d81 = isset($spc8c9ef['isNotify']) && $spc8c9ef['isNotify']; $sp9e3ad2 = $spc8c9ef['id']; $spbdce03 = $spc8c9ef['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp1e1df1 = ''; foreach ($_POST as $sp1e4b49 => $sp7a0550) { if ($sp7a0550 == '' || $sp1e4b49 == 'sign') { continue; } if ($sp1e1df1) { $sp1e1df1 .= '&'; } $sp1e1df1 .= "{$sp1e4b49}={$sp7a0550}"; } if (!isset($_POST['pay_no']) || md5($sp1e1df1 . $spbdce03) != $_POST['sign']) { if ($sp412d81) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp412d81) { echo 'fail'; } return false; } $sp4510be = $_POST['pay_id']; $sp6f1ff6 = (int) round($_POST['price'] * 100); $sp040923 = $_POST['pay_no']; $sp53cf01($sp4510be, $sp6f1ff6, $sp040923); if ($sp412d81) { echo 'success'; } return true; } } }