<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spcbbf66) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spcbbf66; $this->url_return = SYS_URL . '/pay/return/' . $spcbbf66; } function goPay($spc6bf93, $sp30c318, $spc3fe8b, $sp66faf9, $spb959ec) { $sp7ca622 = sprintf('%.2f', $spb959ec / 100); $spe966e2 = $spc6bf93['id']; $sp28e8fd = $spc6bf93['key']; switch ($spc6bf93['payway']) { case 'alipay': $sp4c5fa8 = 1; break; case 'qq': $sp4c5fa8 = 2; break; case 'weixin': $sp4c5fa8 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $spbda5b4 = array('id' => $spe966e2, 'pay_id' => $sp30c318, 'type' => $sp4c5fa8, 'price' => $sp7ca622, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($spbda5b4); $spa0f4ca = ''; $sp0e221e = ''; foreach ($spbda5b4 as $spc37b44 => $spfca62c) { if ($spfca62c == '' || $spc37b44 == 'sign') { continue; } if ($spa0f4ca != '') { $spa0f4ca .= '&'; $sp0e221e .= '&'; } $spa0f4ca .= "{$spc37b44}={$spfca62c}"; $sp0e221e .= "{$spc37b44}=" . urlencode($spfca62c); } $spe8afa9 = $sp0e221e . '&sign=' . md5($spa0f4ca . $sp28e8fd); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $spe8afa9); die; } function verify($spc6bf93, $spc5d9aa) { $sp4dcba6 = isset($spc6bf93['isNotify']) && $spc6bf93['isNotify']; $spe966e2 = $spc6bf93['id']; $sp28e8fd = $spc6bf93['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $spa0f4ca = ''; foreach ($_POST as $spc37b44 => $spfca62c) { if ($spfca62c == '' || $spc37b44 == 'sign') { continue; } if ($spa0f4ca) { $spa0f4ca .= '&'; } $spa0f4ca .= "{$spc37b44}={$spfca62c}"; } if (!isset($_POST['pay_no']) || md5($spa0f4ca . $sp28e8fd) != $_POST['sign']) { if ($sp4dcba6) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp4dcba6) { echo 'fail'; } return false; } $sp30c318 = $_POST['pay_id']; $sp51db0b = intval((double) $_POST['price'] * 100); $sp9fec61 = $_POST['pay_no']; $spc5d9aa($sp30c318, $sp51db0b, $sp9fec61); if ($sp4dcba6) { echo 'success'; } return true; } } }