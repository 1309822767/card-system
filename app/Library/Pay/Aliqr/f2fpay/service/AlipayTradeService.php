<?php
require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . './../../AopSdk.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . './../model/result/AlipayF2FPayResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FQueryResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FRefundResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FPrecreateResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/builder/AlipayTradeQueryContentBuilder.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/builder/AlipayTradeCancelContentBuilder.php'; require dirname(__FILE__) . DIRECTORY_SEPARATOR . '../config/config.php'; class AlipayTradeService { public $gateway_url = 'https://openapi.alipay.com/gateway.do'; public $notify_url; public $sign_type; public $alipay_public_key; public $private_key; public $appid; public $charset = 'UTF-8'; public $token = NULL; private $MaxQueryRetry; private $QueryDuration; public $format = 'json'; function __construct($sp6e4d76) { $this->gateway_url = $sp6e4d76['gatewayUrl']; $this->appid = $sp6e4d76['app_id']; $this->sign_type = $sp6e4d76['sign_type']; $this->private_key = $sp6e4d76['merchant_private_key']; $this->alipay_public_key = $sp6e4d76['alipay_public_key']; $this->charset = $sp6e4d76['charset']; $this->MaxQueryRetry = $sp6e4d76['MaxQueryRetry']; $this->QueryDuration = $sp6e4d76['QueryDuration']; $this->notify_url = $sp6e4d76['notify_url']; if (empty($this->appid) || trim($this->appid) == '') { throw new Exception('appid should not be NULL!'); } if (empty($this->private_key) || trim($this->private_key) == '') { throw new Exception('private_key should not be NULL!'); } if (empty($this->alipay_public_key) || trim($this->alipay_public_key) == '') { throw new Exception('alipay_public_key should not be NULL!'); } if (empty($this->charset) || trim($this->charset) == '') { throw new Exception('charset should not be NULL!'); } if (empty($this->QueryDuration) || trim($this->QueryDuration) == '') { throw new Exception('QueryDuration should not be NULL!'); } if (empty($this->gateway_url) || trim($this->gateway_url) == '') { throw new Exception('gateway_url should not be NULL!'); } if (empty($this->MaxQueryRetry) || trim($this->MaxQueryRetry) == '') { throw new Exception('MaxQueryRetry should not be NULL!'); } if (empty($this->sign_type) || trim($this->sign_type) == '') { throw new Exception('sign_type should not be NULL'); } } function AlipayWapPayService($sp6e4d76) { $this->__construct($sp6e4d76); } public function barPay($sp086f28) { $sp0d1491 = $sp086f28->getOutTradeNo(); $sp9c786b = $sp086f28->getBizContent(); $sp3efb2d = $sp086f28->getAppAuthToken(); $this->writeLog($sp9c786b); $spf631e6 = new AlipayTradePayRequest(); $spf631e6->setBizContent($sp9c786b); $spd6e0e5 = $this->aopclientRequestExecute($spf631e6, NULL, $sp3efb2d); $spd6e0e5 = $spd6e0e5->alipay_trade_pay_response; $spe62cd8 = new AlipayF2FPayResult($spd6e0e5); if (!empty($spd6e0e5) && '10000' == $spd6e0e5->code) { $spe62cd8->setTradeStatus('SUCCESS'); } elseif (!empty($spd6e0e5) && '10003' == $spd6e0e5->code) { $spa86ed7 = new AlipayTradeQueryContentBuilder(); $spa86ed7->setOutTradeNo($sp0d1491); $spa86ed7->setAppAuthToken($sp3efb2d); $spce13a2 = $this->loopQueryResult($spa86ed7); return $this->checkQueryAndCancel($sp0d1491, $sp3efb2d, $spe62cd8, $spce13a2); } elseif ($this->tradeError($spd6e0e5)) { $spa86ed7 = new AlipayTradeQueryContentBuilder(); $spa86ed7->setOutTradeNo($sp0d1491); $spa86ed7->setAppAuthToken($sp3efb2d); $sp10783b = $this->query($spa86ed7); return $this->checkQueryAndCancel($sp0d1491, $sp3efb2d, $spe62cd8, $sp10783b); } else { $spe62cd8->setTradeStatus('FAILED'); } return $spe62cd8; } public function queryTradeResult($sp086f28) { $spd6e0e5 = $this->query($sp086f28); $spe62cd8 = new AlipayF2FQueryResult($spd6e0e5); if ($this->querySuccess($spd6e0e5)) { $spe62cd8->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($spd6e0e5)) { $spe62cd8->setTradeStatus('UNKNOWN'); } else { $spe62cd8->setTradeStatus('FAILED'); } return $spe62cd8; } public function refund($sp086f28) { $sp9c786b = $sp086f28->getBizContent(); $this->writeLog($sp9c786b); $spf631e6 = new AlipayTradeRefundRequest(); $spf631e6->setBizContent($sp9c786b); $spd6e0e5 = $this->aopclientRequestExecute($spf631e6, NULL, $sp086f28->getAppAuthToken()); $spd6e0e5 = $spd6e0e5->alipay_trade_refund_response; $spe62cd8 = new AlipayF2FRefundResult($spd6e0e5); if (!empty($spd6e0e5) && '10000' == $spd6e0e5->code) { $spe62cd8->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($spd6e0e5)) { $spe62cd8->setTradeStatus('UNKNOWN'); } else { $spe62cd8->setTradeStatus('FAILED'); } return $spe62cd8; } public function qrPay($sp086f28) { $sp9c786b = $sp086f28->getBizContent(); $this->writeLog($sp9c786b); $spf631e6 = new AlipayTradePrecreateRequest(); $spf631e6->setBizContent($sp9c786b); $spf631e6->setNotifyUrl($this->notify_url); $spd6e0e5 = $this->aopclientRequestExecute($spf631e6, NULL, $sp086f28->getAppAuthToken()); $spd6e0e5 = $spd6e0e5->alipay_trade_precreate_response; $spe62cd8 = new AlipayF2FPrecreateResult($spd6e0e5); if (!empty($spd6e0e5) && '10000' == $spd6e0e5->code) { $spe62cd8->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($spd6e0e5)) { $spe62cd8->setTradeStatus('UNKNOWN'); } else { $spe62cd8->setTradeStatus('FAILED'); } return $spe62cd8; } public function query($spa86ed7) { $sp5ddb53 = $spa86ed7->getBizContent(); $this->writeLog($sp5ddb53); $spf631e6 = new AlipayTradeQueryRequest(); $spf631e6->setBizContent($sp5ddb53); $spd6e0e5 = $this->aopclientRequestExecute($spf631e6, NULL, $spa86ed7->getAppAuthToken()); return $spd6e0e5->alipay_trade_query_response; } protected function loopQueryResult($spa86ed7) { $sp673cc4 = NULL; for ($sp218d20 = 1; $sp218d20 < $this->MaxQueryRetry; $sp218d20++) { try { sleep($this->QueryDuration); } catch (Exception $sp019ea9) { print $sp019ea9->getMessage(); die; } $sp10783b = $this->query($spa86ed7); if (!empty($sp10783b)) { if ($this->stopQuery($sp10783b)) { return $sp10783b; } $sp673cc4 = $sp10783b; } } return $sp673cc4; } protected function stopQuery($spd6e0e5) { if ('10000' == $spd6e0e5->code) { if ('TRADE_FINISHED' == $spd6e0e5->trade_status || 'TRADE_SUCCESS' == $spd6e0e5->trade_status || 'TRADE_CLOSED' == $spd6e0e5->trade_status) { return true; } } return false; } private function checkQueryAndCancel($sp0d1491, $sp3efb2d, $spe62cd8, $sp10783b) { if ($this->querySuccess($sp10783b)) { $spe62cd8->setTradeStatus('SUCCESS'); $spe62cd8->setResponse($sp10783b); return $spe62cd8; } elseif ($this->queryClose($sp10783b)) { $spe62cd8->setTradeStatus('FAILED'); return $spe62cd8; } $spb0aeb5 = new AlipayTradeCancelContentBuilder(); $spb0aeb5->setAppAuthToken($sp3efb2d); $spb0aeb5->setOutTradeNo($sp0d1491); $sp4f731e = $this->cancel($spb0aeb5); if ($this->tradeError($sp4f731e)) { $spe62cd8->setTradeStatus('UNKNOWN'); } else { $spe62cd8->setTradeStatus('FAILED'); } return $spe62cd8; } protected function querySuccess($sp10783b) { return !empty($sp10783b) && $sp10783b->code == '10000' && ($sp10783b->trade_status == 'TRADE_SUCCESS' || $sp10783b->trade_status == 'TRADE_FINISHED'); } protected function queryClose($sp10783b) { return !empty($sp10783b) && $sp10783b->code == '10000' && $sp10783b->trade_status == 'TRADE_CLOSED'; } protected function tradeError($spd6e0e5) { return empty($spd6e0e5) || $spd6e0e5->code == '20000'; } public function cancel($spb0aeb5) { $sp5ddb53 = $spb0aeb5->getBizContent(); $this->writeLog($sp5ddb53); $spf631e6 = new AlipayTradeCancelRequest(); $spf631e6->setBizContent($sp5ddb53); $spd6e0e5 = $this->aopclientRequestExecute($spf631e6, NULL, $spb0aeb5->getAppAuthToken()); return $spd6e0e5->alipay_trade_cancel_response; } private function aopclientRequestExecute($spf631e6, $sp67df3e = NULL, $sp3efb2d = NULL) { $sp79625b = new AopClient(); $sp79625b->gatewayUrl = $this->gateway_url; $sp79625b->appId = $this->appid; $sp79625b->signType = $this->sign_type; $sp79625b->rsaPrivateKey = $this->private_key; $sp79625b->alipayrsaPublicKey = $this->alipay_public_key; $sp79625b->apiVersion = '1.0'; $sp79625b->postCharset = $this->charset; $sp79625b->format = $this->format; $sp79625b->debugInfo = true; $spe62cd8 = $sp79625b->execute($spf631e6, $sp67df3e, $sp3efb2d); return $spe62cd8; } function writeLog($spcce599) { file_put_contents(dirname(__FILE__) . '/../log/log.txt', date('Y-m-d H:i:s') . '  ' . $spcce599 . '
', FILE_APPEND); } function create_erweima($sp3e892f, $sp5b0542 = '200', $sp5cdeb7 = 'L', $sp6cc4f1 = '0') { $sp3e892f = urlencode($sp3e892f); $sp4ba97e = '<img src="http://chart.apis.google.com/chart?chs=' . $sp5b0542 . 'x' . $sp5b0542 . '&amp;cht=qr&chld=' . $sp5cdeb7 . '|' . $sp6cc4f1 . '&amp;chl=' . $sp3e892f . '"  widht="' . $sp5b0542 . '" height="' . $sp5b0542 . '" />'; return $sp4ba97e; } function create_erweima_url($sp3e892f, $sp5b0542 = '200', $sp5cdeb7 = 'L', $sp6cc4f1 = '0') { $sp3e892f = urlencode($sp3e892f); $sp4ba97e = 'http://chart.apis.google.com/chart?chs=' . $sp5b0542 . 'x' . $sp5b0542 . '&amp;cht=qr&chld=' . $sp5cdeb7 . '|' . $sp6cc4f1 . '&amp;chl=' . $sp3e892f; return $sp4ba97e; } }