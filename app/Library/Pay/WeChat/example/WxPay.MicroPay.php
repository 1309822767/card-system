<?php
require_once '../lib/WxPay.Api.php'; class MicroPay { public function pay($sp81bb55) { $spe62cd8 = WxPayApi::micropay($sp81bb55, 5); if (!array_key_exists('return_code', $spe62cd8) || !array_key_exists('out_trade_no', $spe62cd8) || !array_key_exists('result_code', $spe62cd8)) { echo '接口调用失败,请确认是否输入是否有误！'; throw new WxPayException('接口调用失败！'); } $sp30c318 = $sp81bb55->GetOut_trade_no(); if ($spe62cd8['return_code'] == 'SUCCESS' && $spe62cd8['result_code'] == 'FAIL' && $spe62cd8['err_code'] != 'USERPAYING' && $spe62cd8['err_code'] != 'SYSTEMERROR') { return false; } $spd50119 = 10; while ($spd50119 > 0) { $spf51422 = 0; $sp673cc4 = $this->query($sp30c318, $spf51422); if ($spf51422 == 2) { sleep(2); continue; } else { if ($spf51422 == 1) { return $sp673cc4; } else { return false; } } } if (!$this->cancel($sp30c318)) { throw new WxpayException('撤销单失败！'); } return false; } public function query($sp30c318, &$sp0fc3a6) { $sp0cd32b = new WxPayOrderQuery(); $sp0cd32b->SetOut_trade_no($sp30c318); $spe62cd8 = WxPayApi::orderQuery($sp0cd32b); if ($spe62cd8['return_code'] == 'SUCCESS' && $spe62cd8['result_code'] == 'SUCCESS') { if ($spe62cd8['trade_state'] == 'SUCCESS') { $sp0fc3a6 = 1; return $spe62cd8; } else { if ($spe62cd8['trade_state'] == 'USERPAYING') { $sp0fc3a6 = 2; return false; } } } if ($spe62cd8['err_code'] == 'ORDERNOTEXIST') { $sp0fc3a6 = 0; } else { $sp0fc3a6 = 2; } return false; } public function cancel($sp30c318, $sp8a86f4 = 0) { if ($sp8a86f4 > 10) { return false; } $sp4801bb = new WxPayReverse(); $sp4801bb->SetOut_trade_no($sp30c318); $spe62cd8 = WxPayApi::reverse($sp4801bb); if ($spe62cd8['return_code'] != 'SUCCESS') { return false; } if ($spe62cd8['result_code'] != 'SUCCESS' && $spe62cd8['recall'] == 'N') { return true; } else { if ($spe62cd8['recall'] == 'Y') { return $this->cancel($sp30c318, ++$sp8a86f4); } } return false; } }