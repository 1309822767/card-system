<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp5d3f49) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp5d3f49; $this->url_return = SYS_URL . '/pay/return/' . $sp5d3f49; } function goPay($spc8c9ef, $sp4510be, $sp930bb6, $sp9a31c1, $spfa6477) { $sp7918ab = $spfa6477; $sp2688c6 = strtoupper($spc8c9ef['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $sp2688c6 = 'JSAPI'; $sp693696 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $sp4510be; $spba74ca = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $spc8c9ef['APPID'] . '&redirect_uri=' . urlencode($sp693696) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $spba74ca); die; } $sp816572 = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $spc8c9ef['APPID'] . '&secret=' . $spc8c9ef['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $sp6f1294 = @json_decode(CurlRequest::get($sp816572), true); if (!$sp6f1294 || !isset($sp6f1294['openid'])) { if (isset($sp6f1294['errcode']) && $sp6f1294['errcode'] === 40163) { header('Location: ' . $spba74ca); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($sp6f1294['errcode']) ? $sp6f1294['errcode'] : $sp6f1294) . '<br>' . (isset($sp6f1294['errmsg']) ? $sp6f1294['errmsg'] : $sp6f1294) . '<br>请返回重试</h1>'); } $spabb08a = $sp6f1294['openid']; } else { if ($sp2688c6 === 'JSAPI') { $sp693696 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $sp4510be; header('Location: /qrcode/pay/' . $sp4510be . '/wechat?url=' . urlencode($sp693696)); die; } } $this->defineWxConfig($spc8c9ef); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'WxLog.php'; $sp3f3238 = new \NativePay(); $sp5bf110 = new \WxPayUnifiedOrder(); $sp5bf110->SetBody($sp930bb6); $sp5bf110->SetAttach($sp4510be); $sp5bf110->SetOut_trade_no($sp4510be); $sp5bf110->SetTotal_fee($sp7918ab); $sp5bf110->SetTime_start(date('YmdHis')); $sp5bf110->SetTime_expire(date('YmdHis', time() + 600)); $sp5bf110->SetGoods_tag('pay'); $sp5bf110->SetNotify_url($this->url_notify); $sp5bf110->SetTrade_type($sp2688c6); if ($sp2688c6 === 'MWEB') { $sp5bf110->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($sp2688c6 === 'JSAPI') { $sp5bf110->SetOpenid($spabb08a); } $sp5bf110->SetProduct_id($sp4510be); $sp5bf110->SetSpbill_create_ip(Helper::getIP()); $sp820aff = $sp3f3238->unifiedOrder($sp5bf110); function getValue($sp4510be, $sp820aff, $sp1e4b49) { if (!isset($sp820aff[$sp1e4b49])) { Log::error('Pay.WeChat.goPay, order_no:' . $sp4510be . ', error:' . json_encode($sp820aff)); if (isset($sp820aff['err_code_des'])) { throw new \Exception($sp820aff['err_code_des']); } if (isset($sp820aff['return_msg'])) { throw new \Exception($sp820aff['return_msg']); } throw new \Exception('获取支付数据失败'); } return $sp820aff[$sp1e4b49]; } if ($sp2688c6 === 'NATIVE') { $sp59c732 = getValue($sp4510be, $sp820aff, 'code_url'); header('Location: /qrcode/pay/' . $sp4510be . '/wechat?url=' . urlencode($sp59c732)); } elseif ($sp2688c6 === 'JSAPI') { $sp7c7a93 = array('appId' => $spc8c9ef['APPID'], 'timeStamp' => strval(time()), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($sp4510be, $sp820aff, 'prepay_id'), 'signType' => 'MD5'); $sp69c4ce = new \WxPayJsApiPay(); $sp69c4ce->FromArray($sp7c7a93); $sp7c7a93['paySign'] = $sp69c4ce->MakeSign(); header('Location: /qrcode/pay/' . $sp4510be . '/wechat?url=' . urlencode(json_encode($sp7c7a93))); } elseif ($sp2688c6 === 'MWEB') { $sp59c732 = getValue($sp4510be, $sp820aff, 'mweb_url'); $sp73fb87 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/qrcode/pay/' . $sp4510be . '/wechat?url=query'; echo view('utils.redirect', array('url' => $sp59c732 . '&redirect_url=' . urlencode($sp73fb87))); } die; } private function defineWxConfig($spc8c9ef) { if (!defined('wx_APPID')) { define('wx_APPID', $spc8c9ef['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $spc8c9ef['MCHID']); } if (!defined('wx_KEY')) { define('wx_KEY', $spc8c9ef['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $spc8c9ef['APPSECRET']); } } function verify($spc8c9ef, $sp53cf01) { $sp412d81 = isset($spc8c9ef['isNotify']) && $spc8c9ef['isNotify']; $this->defineWxConfig($spc8c9ef); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxLog.php'; if ($sp412d81) { return (new PayNotifyCallBack($sp53cf01))->Handle(false); } else { $sp4510be = @$spc8c9ef['out_trade_no']; $sp5bf110 = new \WxPayOrderQuery(); $sp5bf110->SetOut_trade_no($sp4510be); $sp820aff = \WxPayApi::orderQuery($sp5bf110); if (array_key_exists('trade_state', $sp820aff) && $sp820aff['trade_state'] == 'SUCCESS') { call_user_func_array($sp53cf01, array($sp820aff['out_trade_no'], $sp820aff['total_fee'], $sp820aff['transaction_id'])); return true; } else { return false; } } } }