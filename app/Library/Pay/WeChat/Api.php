<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spcbbf66) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spcbbf66; $this->url_return = SYS_URL . '/pay/return/' . $spcbbf66; } function goPay($spc6bf93, $sp30c318, $spc3fe8b, $sp66faf9, $spb959ec) { $sp7ca622 = $spb959ec; $sp0a27da = strtoupper($spc6bf93['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $sp0a27da = 'JSAPI'; $sp71e630 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $sp30c318; $spa061ad = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $spc6bf93['APPID'] . '&redirect_uri=' . urlencode($sp71e630) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $spa061ad); die; } $spd3621c = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $spc6bf93['APPID'] . '&secret=' . $spc6bf93['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $sp567373 = @json_decode(CurlRequest::get($spd3621c), true); if (!$sp567373 || !isset($sp567373['openid'])) { if (isset($sp567373['errcode']) && $sp567373['errcode'] === 40163) { header('Location: ' . $spa061ad); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($sp567373['errcode']) ? $sp567373['errcode'] : $sp567373) . '<br>' . (isset($sp567373['errmsg']) ? $sp567373['errmsg'] : $sp567373) . '<br>请返回重试</h1>'); } $sp95b93f = $sp567373['openid']; } $this->defineWxConfig($spc6bf93); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'wxLog.php'; $sp92a4d6 = new \NativePay(); $sp317e70 = new \WxPayUnifiedOrder(); $sp317e70->SetBody($spc3fe8b); $sp317e70->SetAttach($sp30c318); $sp317e70->SetOut_trade_no($sp30c318); $sp317e70->SetTotal_fee($sp7ca622); $sp317e70->SetTime_start(date('YmdHis')); $sp317e70->SetTime_expire(date('YmdHis', time() + 600)); $sp317e70->SetGoods_tag('pay'); $sp317e70->SetNotify_url($this->url_notify); $sp317e70->SetTrade_type($sp0a27da); if ($sp0a27da === 'MWEB') { $sp317e70->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($sp0a27da === 'JSAPI') { $sp317e70->SetOpenid($sp95b93f); } $sp317e70->SetProduct_id($sp30c318); $sp317e70->SetSpbill_create_ip(Helper::getIP()); $spe62cd8 = $sp92a4d6->unifiedOrder($sp317e70); function getValue($sp30c318, $spe62cd8, $spc37b44) { if (!isset($spe62cd8[$spc37b44])) { Log::error('Pay.WeChat.goPay, order_no:' . $sp30c318 . ', error:' . json_encode($spe62cd8)); if (isset($spe62cd8['err_code_des'])) { throw new \Exception($spe62cd8['err_code_des']); } if (isset($spe62cd8['return_msg'])) { throw new \Exception($spe62cd8['return_msg']); } throw new \Exception('获取支付数据失败'); } return $spe62cd8[$spc37b44]; } if ($sp0a27da === 'NATIVE') { $sp81923e = getValue($sp30c318, $spe62cd8, 'code_url'); header('Location: /qrcode/pay/' . $sp30c318 . '/wechat?url=' . urlencode($sp81923e)); } elseif ($sp0a27da === 'JSAPI') { $sp342eea = array('appId' => $spc6bf93['APPID'], 'timeStamp' => time(), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($sp30c318, $spe62cd8, 'prepay_id'), 'signType' => 'MD5'); $spbda5b4 = new \WxPayJsApiPay(); $spbda5b4->FromArray($sp342eea); $sp342eea['paySign'] = $spbda5b4->MakeSign(); header('Location: /qrcode/pay/' . $sp30c318 . '/wechat?url=' . urlencode(json_encode($sp342eea))); } elseif ($sp0a27da === 'MWEB') { $sp81923e = getValue($sp30c318, $spe62cd8, 'mweb_url'); $spf56c82 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/qrcode/pay/' . $sp30c318 . '/wechat?url=h5'; echo view('utils.redirect', array('url' => $sp81923e . '&redirect_url=' . urlencode($spf56c82))); } die; } private function defineWxConfig($spc6bf93) { if (!defined('wx_APPID')) { define('wx_APPID', $spc6bf93['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $spc6bf93['MCHID']); } if (!defined('wx_KEY')) { define('wx_KEY', $spc6bf93['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $spc6bf93['APPSECRET']); } } function verify($spc6bf93, $spc5d9aa) { $sp4dcba6 = isset($spc6bf93['isNotify']) && $spc6bf93['isNotify']; $this->defineWxConfig($spc6bf93); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'wxLog.php'; if ($sp4dcba6) { return (new PayNotifyCallBack($spc5d9aa))->Handle(false); } else { $sp30c318 = @$spc6bf93['out_trade_no']; $sp317e70 = new \WxPayOrderQuery(); $sp317e70->SetOut_trade_no($sp30c318); $spe62cd8 = \WxPayApi::orderQuery($sp317e70); if (array_key_exists('trade_state', $spe62cd8) && $spe62cd8['trade_state'] == 'SUCCESS') { call_user_func_array($spc5d9aa, array($spe62cd8['out_trade_no'], $spe62cd8['total_fee'], $spe62cd8['transaction_id'])); return true; } else { return false; } } } }