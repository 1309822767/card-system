<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp5d3f49) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp5d3f49; $this->url_return = SYS_URL . '/pay/return/' . $sp5d3f49; } function goPay($spc8c9ef, $sp4510be, $sp930bb6, $sp9a31c1, $spfa6477) { $spdae190 = strtolower($spc8c9ef['payway']); if (!isset($spc8c9ef['id'])) { throw new \Exception('请设置 id'); } $sp43c518 = array(); if ($spdae190 == 'qq') { $sp43c518 = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($spdae190 == 'alipay') { $sp43c518 = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $sp74b8e5 = ''; $sp7de34c = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $spc8c9ef['id'] . '&opuid=&reqid=' . $sp4510be, $sp74b8e5, $sp43c518); $spfe9e36 = static::str_between($sp7de34c, 'reqid":"', '"'); $sp8174c6 = static::str_between($sp7de34c, 'currency":"', '"'); if ($spfe9e36 == '' || $sp8174c6 == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $sp7de34c); throw new \Exception('获取支付请求id失败'); } $sp8f216a = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $spfa6477 . '&openid=&appid=&huid=' . $spc8c9ef['id'] . '&opuid=&reqid=' . $spfe9e36 . '&balance=0&currency=' . $sp8174c6, $sp74b8e5, $sp43c518); $sp820aff = json_decode($sp8f216a, true); $spe85be4 = static::str_between($sp8f216a, 'syssn":"', '"'); if (!$sp820aff || $spe85be4 == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp8f216a); throw new \Exception('生成支付单号失败#1'); } if ($sp820aff['respcd'] !== '0000') { if (isset($sp820aff['respmsg']) && $sp820aff['respmsg'] !== '') { throw new \Exception($sp820aff['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp8f216a); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($sp4510be)->update(array('pay_trade_no' => $spe85be4)); header('location: /qrcode/pay/' . $sp4510be . '/qf_' . $spdae190 . '?url=' . urlencode(json_encode($sp820aff['data']['pay_params']))); } function verify($spc8c9ef, $sp53cf01) { $sp61541f = \App\Order::whereOrderNo($spc8c9ef['out_trade_no'])->firstOrFail(); $spe85be4 = $sp61541f->pay_trade_no; $sp8088e9 = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $spe85be4); $sp338929 = json_decode($sp8088e9, true); if (!$sp8088e9) { throw new \Exception('query error'); } if (!isset($sp338929['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $sp8088e9); throw new \Exception('获取支付结果失败'); } if ($sp338929['respcd'] !== '0000') { return false; } $spcdcf8d = (int) static::str_between($sp8088e9, 'trade_amt":', ','); if ($spcdcf8d === 0) { $spcdcf8d = (int) static::str_between($sp8088e9, 'txamt":', ','); if ($spcdcf8d === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $sp8088e9); throw new \Exception('获取支付金额失败'); } } if ($sp338929['respcd'] === '0000') { $sp53cf01($spc8c9ef['out_trade_no'], $spcdcf8d, $spe85be4); return true; } return false; } public static function str_between($sp512d95, $spa81293, $spe0612d) { $sp5fbc33 = stripos($sp512d95, $spa81293); if ($sp5fbc33 === false) { return ''; } $spf6d0a3 = stripos($sp512d95, $spe0612d, $sp5fbc33 + strlen($spa81293)); if ($spf6d0a3 === false || $sp5fbc33 >= $spf6d0a3) { return ''; } $sp74e9d9 = strlen($spa81293); $sp6f1294 = substr($sp512d95, $sp5fbc33 + $sp74e9d9, $spf6d0a3 - $sp5fbc33 - $sp74e9d9); return $sp6f1294; } }