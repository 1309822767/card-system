<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spcbbf66) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spcbbf66; $this->url_return = SYS_URL . '/pay/return/' . $spcbbf66; } function goPay($spc6bf93, $sp30c318, $spc3fe8b, $sp66faf9, $spb959ec) { $sp08876a = strtolower($spc6bf93['payway']); if (!isset($spc6bf93['id'])) { throw new \Exception('请设置 id'); } $sp79f0c2 = array(); if ($sp08876a == 'qq') { $sp79f0c2 = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($sp08876a == 'alipay') { $sp79f0c2 = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $sp6df092 = ''; $sp54acad = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $spc6bf93['id'] . '&opuid=&reqid=' . $sp30c318, $sp6df092, $sp79f0c2); $sp574c49 = static::strBetween($sp54acad, 'reqid":"', '"'); $sp496fb0 = static::strBetween($sp54acad, 'currency":"', '"'); if ($sp574c49 == '' || $sp496fb0 == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $sp54acad); throw new \Exception('获取支付请求id失败'); } $sp1ac3a8 = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $spb959ec . '&openid=&appid=&huid=' . $spc6bf93['id'] . '&opuid=&reqid=' . $sp574c49 . '&balance=0&currency=' . $sp496fb0, $sp6df092, $sp79f0c2); $spe62cd8 = json_decode($sp1ac3a8, true); $sp4eda46 = static::strBetween($sp1ac3a8, 'syssn":"', '"'); if (!$spe62cd8 || $sp4eda46 == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp1ac3a8); throw new \Exception('生成支付单号失败#1'); } if ($spe62cd8['respcd'] !== '0000') { if (isset($spe62cd8['respmsg']) && $spe62cd8['respmsg'] !== '') { throw new \Exception($spe62cd8['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp1ac3a8); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($sp30c318)->update(array('pay_trade_no' => $sp4eda46)); header('location: /qrcode/pay/' . $sp30c318 . '/qf_' . $sp08876a . '?url=' . urlencode(json_encode($spe62cd8['data']['pay_params']))); } function verify($spc6bf93, $spc5d9aa) { $sp09599a = \App\Order::whereOrderNo($spc6bf93['out_trade_no'])->firstOrFail(); $sp4eda46 = $sp09599a->pay_trade_no; $spd8d8b6 = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $sp4eda46); $sp36028b = json_decode($spd8d8b6, true); if (!$spd8d8b6) { throw new \Exception('query error'); } if (!isset($sp36028b['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $spd8d8b6); throw new \Exception('获取支付结果失败'); } if ($sp36028b['respcd'] !== '0000') { return false; } $sp92c60a = (int) static::strBetween($spd8d8b6, 'trade_amt":', ','); if ($sp92c60a === 0) { $sp92c60a = (int) static::strBetween($spd8d8b6, 'txamt":', ','); if ($sp92c60a === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $spd8d8b6); throw new \Exception('获取支付金额失败'); } } if ($sp36028b['respcd'] === '0000') { $spc5d9aa($spc6bf93['out_trade_no'], $sp92c60a, $sp4eda46); return true; } return false; } public static function strBetween($sp4e169a, $sp7bbfcf, $sp6c774d) { $sp470cc8 = stripos($sp4e169a, $sp7bbfcf); if ($sp470cc8 === false) { return ''; } $spa2e1ee = stripos($sp4e169a, $sp6c774d, $sp470cc8 + strlen($sp7bbfcf)); if ($spa2e1ee === false || $sp470cc8 >= $spa2e1ee) { return ''; } $sp60db54 = strlen($sp7bbfcf); $sp567373 = substr($sp4e169a, $sp470cc8 + $sp60db54, $spa2e1ee - $sp470cc8 - $sp60db54); return $sp567373; } }