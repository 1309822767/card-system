<?php
namespace App\Library\Pay\AliAop; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; private $aop = null; public function __construct($sp5d3f49) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp5d3f49; $this->url_return = SYS_URL . '/pay/return/' . $sp5d3f49; } private function aop($spc8c9ef) { if ($this->aop === null) { $spb605cf = \Alipay\Key\AlipayKeyPair::create('-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spc8c9ef['merchant_private_key'], 64, '
', true) . '
-----END RSA PRIVATE KEY-----', '-----BEGIN PUBLIC KEY-----
' . wordwrap($spc8c9ef['alipay_public_key'], 64, '
', true) . '
-----END PUBLIC KEY-----'); $this->aop = new \Alipay\AopClient($spc8c9ef['app_id'], $spb605cf); } return $this->aop; } function goPay($spc8c9ef, $sp4510be, $sp930bb6, $sp9a31c1, $spfa6477) { $sp7918ab = sprintf('%.2f', $spfa6477 / 100); if ($spc8c9ef['payway'] === 'f2f') { $sp6a5e99 = \Alipay\AlipayRequestFactory::create('alipay.trade.precreate', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp4510be, 'total_amount' => $sp7918ab, 'subject' => $sp930bb6))); $sp820aff = $this->aop($spc8c9ef)->execute($sp6a5e99)->getData(); header('location: /qrcode/pay/' . $sp4510be . '/aliqr?url=' . urlencode($sp820aff['qr_code'])); } elseif ($spc8c9ef['payway'] === 'pc') { $sp6a5e99 = \Alipay\AlipayRequestFactory::create('alipay.trade.page.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp4510be, 'product_code' => 'FAST_INSTANT_TRADE_PAY', 'total_amount' => $sp7918ab, 'subject' => $sp930bb6))); $sp820aff = $this->aop($spc8c9ef)->pageExecuteUrl($sp6a5e99); header('location: ' . $sp820aff); } elseif ($spc8c9ef['payway'] === 'mobile') { $sp6a5e99 = \Alipay\AlipayRequestFactory::create('alipay.trade.wap.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp4510be, 'product_code' => 'QUICK_WAP_WAY', 'total_amount' => $sp7918ab, 'subject' => $sp930bb6))); $sp820aff = $this->aop($spc8c9ef)->pageExecuteUrl($sp6a5e99); header('location: ' . $sp820aff); } die; } function verify($spc8c9ef, $sp53cf01) { $sp412d81 = isset($spc8c9ef['isNotify']) && $spc8c9ef['isNotify']; if ($sp412d81) { if ($this->aop($spc8c9ef)->verify($_POST)) { if ($_POST['trade_status'] === 'TRADE_SUCCESS') { $sp040923 = $_POST['trade_no']; $sp6f1ff6 = (int) round($_POST['total_amount'] * 100); $sp53cf01($_POST['out_trade_no'], $sp6f1ff6, $sp040923); } } else { Log::error('Pay.AliAop.goPay.verify Error: ' . json_encode($_POST)); } echo 'success'; die; } if (!empty($spc8c9ef['out_trade_no'])) { $sp4510be = $spc8c9ef['out_trade_no']; $sp6a5e99 = \Alipay\AlipayRequestFactory::create('alipay.trade.query', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp4510be))); try { $sp820aff = $this->aop($spc8c9ef)->execute($sp6a5e99)->getData(); } catch (\Throwable $spbcc446) { return false; } if ($sp820aff['trade_status'] === 'TRADE_SUCCESS') { $sp040923 = $sp820aff['trade_no']; $sp6f1ff6 = (int) round($sp820aff['total_amount'] * 100); $sp53cf01($sp820aff['out_trade_no'], $sp6f1ff6, $sp040923); return true; } } else { $sp0653cf = $this->aop($spc8c9ef)->verify($_GET); if (!$sp0653cf) { throw new \Exception('支付宝签名校验失败'); } $sp040923 = $_GET['trade_no']; $sp6f1ff6 = (int) round($_GET['total_amount'] * 100); $sp53cf01($_GET['out_trade_no'], $sp6f1ff6, $sp040923); return true; } return false; } }