<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spcbbf66) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spcbbf66; $this->url_return = SYS_URL . '/pay/return/' . $spcbbf66; } private function getAccessToken($spc6bf93) { $sp6b7109 = $spc6bf93['client_id']; $sp288596 = $spc6bf93['client_secret']; $sp560b8c = array('kdt_id' => $spc6bf93['kdt_id']); $spe62cd8 = (new Open\Token($sp6b7109, $sp288596))->getToken('self', $sp560b8c); if (!isset($spe62cd8['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($spe62cd8)); throw new \Exception('平台支付Token获取失败'); } return $spe62cd8['access_token']; } function goPay($spc6bf93, $sp30c318, $spc3fe8b, $sp66faf9, $spb959ec) { $sp08876a = strtolower($spc6bf93['payway']); try { $sp86d993 = $this->getAccessToken($spc6bf93); $sp9bf6b7 = new Open\Client($sp86d993); } catch (\Exception $sp019ea9) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $sp019ea9)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp342eea = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $spb959ec, 'qr_name' => $spc3fe8b, 'qr_source' => $sp30c318); $spe62cd8 = $sp9bf6b7->get('youzan.pay.qrcode.create', '3.0.0', $sp342eea); $spe62cd8 = isset($spe62cd8['response']) ? $spe62cd8['response'] : $spe62cd8; if (!isset($spe62cd8['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($spe62cd8)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($sp30c318)->update(array('pay_trade_no' => $spe62cd8['qr_id'])); header('location: /qrcode/pay/' . $sp30c318 . '/youzan_' . strtolower($sp08876a) . '?url=' . urlencode($spe62cd8['qr_url'])); die; } function verify($spc6bf93, $spc5d9aa) { $sp4dcba6 = isset($spc6bf93['isNotify']) && $spc6bf93['isNotify']; $sp6b7109 = $spc6bf93['client_id']; $sp288596 = $spc6bf93['client_secret']; if ($sp4dcba6) { $sp7f196e = file_get_contents('php://input'); $spbda5b4 = json_decode($sp7f196e, true); if (@$spbda5b4['test']) { echo 'test success'; return false; } try { $spb18c75 = $spbda5b4['msg']; } catch (\Exception $sp019ea9) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $sp019ea9, 'post_raw' => $sp7f196e)); echo 'fatal error'; return false; } $spcb4914 = $sp6b7109 . '' . $spb18c75 . '' . $sp288596; $spa0f4ca = md5($spcb4914); if ($spa0f4ca != $spbda5b4['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $spcb4914 . ', $sign' . $spa0f4ca); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $spb18c75 = json_decode(urldecode($spb18c75), true); if ($spbda5b4['type'] === 'TRADE_ORDER_STATE' && $spb18c75['status'] === 'TRADE_SUCCESS') { try { $sp86d993 = $this->getAccessToken($spc6bf93); $sp9bf6b7 = new Open\Client($sp86d993); } catch (\Exception $sp019ea9) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $sp019ea9)); echo 'fatal error'; return false; } $sp342eea = array('tid' => $spb18c75['tid']); $spe62cd8 = $sp9bf6b7->get('youzan.trade.get', '3.0.0', $sp342eea); if (isset($spe62cd8['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $spe62cd8['error_response']['msg']); echo 'fatal error'; return false; } $sp5f5577 = $spe62cd8['response']['trade']; $sp09599a = \App\Order::where('pay_trade_no', $sp5f5577['qr_id'])->first(); if ($sp09599a) { $spf6a1ea = $spb18c75['tid']; $spc5d9aa($sp09599a->order_no, intval($sp5f5577['payment'] * 100), $spf6a1ea); } } return true; } else { $sp30c318 = @$spc6bf93['out_trade_no']; if (strlen($sp30c318) < 5) { throw new \Exception('交易单号未传入'); } $sp09599a = \App\Order::whereOrderNo($sp30c318)->firstOrFail(); if (!$sp09599a->pay_trade_no || !strlen($sp09599a->pay_trade_no)) { return false; } try { $sp86d993 = $this->getAccessToken($spc6bf93); $sp9bf6b7 = new Open\Client($sp86d993); } catch (\Exception $sp019ea9) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $sp019ea9)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp342eea = array('qr_id' => $sp09599a->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $spe62cd8 = $sp9bf6b7->get('youzan.trades.qr.get', '3.0.0', $sp342eea); $sp760640 = isset($spe62cd8['response']) ? $spe62cd8['response'] : $spe62cd8; if (!isset($sp760640['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $spe62cd8)); return false; } if ($sp760640['total_results'] > 0 && count($sp760640['qr_trades']) > 0 && isset($sp760640['qr_trades'][0]['qr_id']) && $sp760640['qr_trades'][0]['qr_id'] === $sp09599a->pay_trade_no) { $sp467afb = $sp760640['qr_trades'][0]; $spf6a1ea = $sp467afb['tid']; $spc5d9aa($sp30c318, intval($sp467afb['real_price'] * 100), $spf6a1ea); return true; } else { return false; } } } }