<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp5d3f49) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp5d3f49; $this->url_return = SYS_URL . '/pay/return/' . $sp5d3f49; } private function getAccessToken($spc8c9ef) { $spaa708d = $spc8c9ef['client_id']; $spd1096f = $spc8c9ef['client_secret']; $sp04b280 = array('kdt_id' => $spc8c9ef['kdt_id']); $sp820aff = (new Open\Token($spaa708d, $spd1096f))->getToken('self', $sp04b280); if (!isset($sp820aff['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($sp820aff)); throw new \Exception('平台支付Token获取失败'); } return $sp820aff['access_token']; } function goPay($spc8c9ef, $sp4510be, $sp930bb6, $sp9a31c1, $spfa6477) { $spdae190 = strtolower($spc8c9ef['payway']); try { $sp1bda2e = $this->getAccessToken($spc8c9ef); $spb26a9e = new Open\Client($sp1bda2e); } catch (\Exception $spbcc446) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $spbcc446)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp7c7a93 = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $spfa6477, 'qr_name' => $sp930bb6, 'qr_source' => $sp4510be); $sp820aff = $spb26a9e->get('youzan.pay.qrcode.create', '3.0.0', $sp7c7a93); $sp820aff = isset($sp820aff['response']) ? $sp820aff['response'] : $sp820aff; if (!isset($sp820aff['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($sp820aff)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($sp4510be)->update(array('pay_trade_no' => $sp820aff['qr_id'])); header('location: /qrcode/pay/' . $sp4510be . '/youzan_' . strtolower($spdae190) . '?url=' . urlencode($sp820aff['qr_url'])); die; } function verify($spc8c9ef, $sp53cf01) { $sp412d81 = isset($spc8c9ef['isNotify']) && $spc8c9ef['isNotify']; $spaa708d = $spc8c9ef['client_id']; $spd1096f = $spc8c9ef['client_secret']; if ($sp412d81) { $sp07effe = file_get_contents('php://input'); $sp69c4ce = json_decode($sp07effe, true); if (@$sp69c4ce['test']) { echo 'test success'; return false; } try { $sp3a6f3c = $sp69c4ce['msg']; } catch (\Exception $spbcc446) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $spbcc446, 'post_raw' => $sp07effe)); echo 'fatal error'; return false; } $spc013b2 = $spaa708d . '' . $sp3a6f3c . '' . $spd1096f; $sp1e1df1 = md5($spc013b2); if ($sp1e1df1 != $sp69c4ce['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $spc013b2 . ', $sign' . $sp1e1df1); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $sp3a6f3c = json_decode(urldecode($sp3a6f3c), true); if ($sp69c4ce['type'] === 'TRADE_ORDER_STATE' && $sp3a6f3c['status'] === 'TRADE_SUCCESS') { try { $sp1bda2e = $this->getAccessToken($spc8c9ef); $spb26a9e = new Open\Client($sp1bda2e); } catch (\Exception $spbcc446) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $spbcc446)); echo 'fatal error'; return false; } $sp7c7a93 = array('tid' => $sp3a6f3c['tid']); $sp820aff = $spb26a9e->get('youzan.trade.get', '3.0.0', $sp7c7a93); if (isset($sp820aff['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $sp820aff['error_response']['msg']); echo 'fatal error'; return false; } $sp6f655d = $sp820aff['response']['trade']; $sp61541f = \App\Order::where('pay_trade_no', $sp6f655d['qr_id'])->first(); if ($sp61541f) { $sp5f8fd4 = $sp3a6f3c['tid']; $sp53cf01($sp61541f->order_no, (int) round($sp6f655d['payment'] * 100), $sp5f8fd4); } } return true; } else { $sp4510be = @$spc8c9ef['out_trade_no']; if (strlen($sp4510be) < 5) { throw new \Exception('交易单号未传入'); } $sp61541f = \App\Order::whereOrderNo($sp4510be)->firstOrFail(); if (!$sp61541f->pay_trade_no || !strlen($sp61541f->pay_trade_no)) { return false; } try { $sp1bda2e = $this->getAccessToken($spc8c9ef); $spb26a9e = new Open\Client($sp1bda2e); } catch (\Exception $spbcc446) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $spbcc446)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp7c7a93 = array('qr_id' => $sp61541f->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $sp820aff = $spb26a9e->get('youzan.trades.qr.get', '3.0.0', $sp7c7a93); $sp67ee87 = isset($sp820aff['response']) ? $sp820aff['response'] : $sp820aff; if (!isset($sp67ee87['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $sp820aff)); return false; } if ($sp67ee87['total_results'] > 0 && count($sp67ee87['qr_trades']) > 0 && isset($sp67ee87['qr_trades'][0]['qr_id']) && $sp67ee87['qr_trades'][0]['qr_id'] === $sp61541f->pay_trade_no) { $sp4e195d = $sp67ee87['qr_trades'][0]; $sp5f8fd4 = $sp4e195d['tid']; $sp53cf01($sp4510be, (int) round($sp4e195d['real_price'] * 100), $sp5f8fd4); return true; } else { return false; } } } }