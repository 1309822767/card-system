<?php
namespace App\Library\Pay\QweBank; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp5d3f49) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp5d3f49; $this->url_return = SYS_URL . '/pay/return/' . $sp5d3f49; } function getAccessToken($spc8c9ef) { $sp465155 = str_random(5); $spdbbd1e = time() . '00'; $sp1e1df1 = strtoupper(md5('merchantNo=' . $spc8c9ef['mchid'] . '&nonce=' . $sp465155 . '&timestamp=' . $spdbbd1e . '&key=' . $spc8c9ef['key'])); $sp7c7a93 = json_encode(array('merchantNo' => $spc8c9ef['mchid'], 'key' => $spc8c9ef['key'], 'nonce' => $sp465155, 'timestamp' => $spdbbd1e, 'sign' => $sp1e1df1), JSON_FORCE_OBJECT); $sp74b8e5 = ''; $sp7025bb = CurlRequest::post('http://api.qwebank.top/open/v1/getAccessToken/merchant', $sp7c7a93, $sp74b8e5, array('Content-Type' => 'application/json')); $sp6f1294 = @json_decode($sp7025bb, true); if (!is_array($sp6f1294) || !isset($sp6f1294['value']) || !isset($sp6f1294['value']['accessToken'])) { Log::error('Pay.QweBank.getAccessToken Error: ' . $sp7025bb); throw new \Exception('获取支付渠道失败，请联系客服反馈'); } return $sp6f1294['value']['accessToken']; } function goPay($spc8c9ef, $sp4510be, $sp930bb6, $sp9a31c1, $spfa6477) { if (!isset($spc8c9ef['mchid'])) { throw new \Exception('请填写 mchid'); } if (!isset($spc8c9ef['key'])) { throw new \Exception('请填写 key'); } $sp2688c6 = $spc8c9ef['payway']; $sp7c7a93 = array('accessToken' => $this->getAccessToken($spc8c9ef), 'param' => array('outTradeNo' => $sp4510be, 'money' => $spfa6477, 'type' => 'T0', 'body' => $sp930bb6, 'detail' => $sp930bb6, 'notifyUrl' => $this->url_notify, 'successUrl' => $this->url_return, 'productId' => '12313', 'timestamp' => strval(time()), 'sign' => '1')); if ($sp2688c6 === 'wechatWapPay') { $sp7c7a93['param']['merchantIp'] = Helper::getIP(); } if ($sp2688c6 === 'bankPay') { if (!isset($spc8c9ef['bankName'])) { throw new \Exception('请填写 bankName'); } $sp7c7a93['param']['bankName'] = $spc8c9ef['bankName']; } $sp74b8e5 = ''; $sp7025bb = CurlRequest::post('http://api.qwebank.top/open/v1/order/' . $sp2688c6, json_encode($sp7c7a93, JSON_FORCE_OBJECT), $sp74b8e5, array('Content-Type' => 'application/json')); $sp6f1294 = @json_decode($sp7025bb, true); if (!is_array($sp6f1294) || !isset($sp6f1294['success']) || !isset($sp6f1294['value'])) { Log::error('Pay.QweBank.goPay Error: ' . $sp7025bb); throw new \Exception('提交订单到支付渠道失败，请联系客服反馈'); } header('Location: ' . $sp6f1294['value']); die; } function verify($spc8c9ef, $sp53cf01) { $sp412d81 = isset($spc8c9ef['isNotify']) && $spc8c9ef['isNotify']; $sp820aff = false; if ($sp412d81) { $sp512d95 = 'merchantNo=' . $_REQUEST['merchantNo'] . '&no=' . $_REQUEST['no'] . '&nonce=' . $_REQUEST['nonce'] . '&timestamp=' . $_REQUEST['timestamp'] . '&key=' . $spc8c9ef['key']; if (md5($sp512d95) !== $_REQUEST['sign']) { $sp820aff = true; } echo $sp820aff ? 'SUCCESS' : 'fail'; } else { $sp4510be = $_REQUEST['outTradeNo']; $sp7c7a93 = array('accessToken' => $this->getAccessToken($spc8c9ef), 'param' => $sp4510be); $sp74b8e5 = ''; $sp7025bb = CurlRequest::post('http://api.qwebank.top/open/v1/order/getByCustomerNo', json_encode($sp7c7a93, JSON_FORCE_OBJECT), $sp74b8e5, array('Content-Type' => 'application/json')); $sp6f1294 = @json_decode($sp7025bb, true); if (!is_array($sp6f1294) || !isset($sp6f1294['success']) || !isset($sp6f1294['value'])) { Log::error('Pay.QweBank.verify.getByCustomerNo Error: ' . $sp7025bb); return false; } $sp820aff = $sp6f1294['value']['done'] === true; } if ($sp820aff) { $sp4510be = $_REQUEST['outTradeNo']; $sp6f1ff6 = $_REQUEST['money']; $spbad2bd = $_REQUEST['no']; $sp53cf01($sp4510be, $sp6f1ff6, $spbad2bd); return true; } return false; } }