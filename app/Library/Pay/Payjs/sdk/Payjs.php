<?php
namespace Xhat\Payjs; class Payjs { private $mchid; private $key; private $api_url_native; private $api_url_cashier; private $api_url_refund; private $api_url_close; private $api_url_check; private $api_url_user; private $api_url_info; private $api_url_bank; public function __construct($spc8c9ef = null) { if (!$spc8c9ef) { die('config needed'); } $this->mchid = $spc8c9ef['mchid']; $this->key = $spc8c9ef['key']; $sp0d73aa = isset($spc8c9ef['api_url']) ? $spc8c9ef['api_url'] : 'https://payjs.cn/api/'; $this->api_url_native = $sp0d73aa . 'native'; $this->api_url_cashier = $sp0d73aa . 'cashier'; $this->api_url_refund = $sp0d73aa . 'refund'; $this->api_url_close = $sp0d73aa . 'close'; $this->api_url_check = $sp0d73aa . 'check'; $this->api_url_user = $sp0d73aa . 'user'; $this->api_url_info = $sp0d73aa . 'info'; $this->api_url_bank = $sp0d73aa . 'bank'; } public function native(array $sp69c4ce) { $this->url = $this->api_url_native; return $this->post($sp69c4ce); } public function cashier(array $sp69c4ce) { $this->url = $this->api_url_cashier; $sp69c4ce = $this->sign($sp69c4ce); $sp59c732 = $this->url . '?' . http_build_query($sp69c4ce); return $sp59c732; } public function refund($spc80011) { $this->url = $this->api_url_refund; $sp69c4ce = array('payjs_order_id' => $spc80011); return $this->post($sp69c4ce); } public function close($spc80011) { $this->url = $this->api_url_close; $sp69c4ce = array('payjs_order_id' => $spc80011); return $this->post($sp69c4ce); } public function check($spc80011) { $this->url = $this->api_url_check; $sp69c4ce = array('payjs_order_id' => $spc80011); return $this->post($sp69c4ce); } public function user($spabb08a) { $this->url = $this->api_url_user; $sp69c4ce = array('openid' => $spabb08a); return $this->post($sp69c4ce); } public function info() { $this->url = $this->api_url_info; $sp69c4ce = array(); return $this->post($sp69c4ce); } public function bank($sp535158) { $this->url = $this->api_url_bank; $sp69c4ce = array('bank' => $sp535158); return $this->post($sp69c4ce); } public function notify() { $sp69c4ce = $_POST; if ($this->checkSign($sp69c4ce) === true) { return $sp69c4ce; } else { return '验签失败'; } } public function sign(array $sp69c4ce) { $sp69c4ce['mchid'] = $this->mchid; array_filter($sp69c4ce); ksort($sp69c4ce); $sp69c4ce['sign'] = strtoupper(md5(urldecode(http_build_query($sp69c4ce) . '&key=' . $this->key))); return $sp69c4ce; } public function checkSign($sp69c4ce) { $sp6dcd7f = $sp69c4ce['sign']; unset($sp69c4ce['sign']); array_filter($sp69c4ce); ksort($sp69c4ce); $sp1e1df1 = strtoupper(md5(urldecode(http_build_query($sp69c4ce) . '&key=' . $this->key))); return $sp6dcd7f == $sp1e1df1 ? true : false; } private static function curl_post($sp59c732, $sp79a6d8 = '') { $sp43c518['Accept'] = '*/*'; $sp43c518['Referer'] = $sp59c732; $sp43c518['Content-Type'] = 'application/x-www-form-urlencoded'; $sp43c518['User-Agent'] = 'ni shi sha bi ba, yi ge sdk hai you di san fang ku'; $sp852727 = array(); foreach ($sp43c518 as $spee3819 => $sp53e898) { $sp852727[] = $spee3819 . ': ' . $sp53e898; } $sp852727[] = 'Expect:'; $sp72f257 = curl_init(); curl_setopt($sp72f257, CURLOPT_URL, $sp59c732); curl_setopt($sp72f257, CURLOPT_POST, 1); curl_setopt($sp72f257, CURLOPT_POSTFIELDS, $sp79a6d8); curl_setopt($sp72f257, CURLOPT_TIMEOUT, 10); curl_setopt($sp72f257, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp72f257, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp72f257, CURLOPT_HEADER, 1); curl_setopt($sp72f257, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp72f257, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp72f257, CURLOPT_HTTPHEADER, $sp852727); $sp31c557 = curl_exec($sp72f257); $sp816c80 = curl_getinfo($sp72f257, CURLINFO_HEADER_SIZE); $sp9a31c1 = substr($sp31c557, $sp816c80); curl_close($sp72f257); return $sp9a31c1; } public function post($sp69c4ce) { $sp69c4ce = $this->sign($sp69c4ce); return json_decode(self::curl_post($this->url, http_build_query($sp69c4ce)), true); } }