<?php
namespace App\Library; use App\Order; use App\User; use App\FundRecord; use Illuminate\Support\Facades\DB; class FundHelper { public static function orderSuccess($sp09599a, callable $spfddae9) { $sp7652a3 = $sp09599a->user_id; $spd4e15a = $sp09599a->income; try { return DB::transaction(function () use($sp09599a, $sp7652a3, $spd4e15a, $spfddae9) { if ($spfddae9() === Order::STATUS_SUCCESS) { $sp5b5487 = User::where('id', $sp7652a3)->lockForUpdate()->firstOrFail(); $sp5b5487->m_all += $spd4e15a; $sp5b5487->saveOrFail(); $sp1f2bf3 = new FundRecord(); $sp1f2bf3->user_id = $sp7652a3; $sp1f2bf3->type = FundRecord::TYPE_IN; $sp1f2bf3->amount = $spd4e15a; $sp1f2bf3->balance = $sp5b5487->m_balance; $sp1f2bf3->remark = '订单#' . $sp09599a->order_no; $sp1f2bf3->order_id = $sp09599a->id; $sp1f2bf3->saveOrFail(); } return true; }); } catch (\Throwable $sp019ea9) { $spb18c75 = 'FundHelper.orderSuccess error, user_id:' . $sp7652a3 . ',amount:' . $spd4e15a . ',order_no:' . $sp09599a->order_no; \Illuminate\Support\Facades\Log::error($spb18c75 . ' with exception:', array('Exception' => $sp019ea9)); return false; } } public static function orderFreeze($sp09599a, $sp73594d) { if ($sp09599a->status === Order::STATUS_FROZEN || $sp09599a->status === Order::STATUS_REFUND) { return true; } $sp7652a3 = $sp09599a->user_id; try { return DB::transaction(function () use($sp09599a, $sp7652a3, $sp73594d) { $sp09599a->status = \App\Order::STATUS_FROZEN; $sp09599a->frozen_reason = $sp73594d; $sp09599a->saveOrFail(); $sp5b5487 = User::where('id', $sp7652a3)->lockForUpdate()->firstOrFail(); if ($sp09599a->cards()->exists()) { $sp5b5487->m_frozen += $sp09599a->income; $sp5b5487->saveOrFail(); $sp1f2bf3 = new FundRecord(); $sp1f2bf3->user_id = $sp7652a3; $sp1f2bf3->type = FundRecord::TYPE_OUT; $sp1f2bf3->amount = -$sp09599a->income; $sp1f2bf3->balance = $sp5b5487->m_balance; $sp1f2bf3->remark = $sp73594d . ', 冻结订单#' . $sp09599a->order_no; $sp1f2bf3->order_id = $sp09599a->id; $sp1f2bf3->saveOrFail(); } else { if ($sp09599a->paid_at === NULL) { $sp2c7393 = '未付款'; } else { $sp2c7393 = '未发货'; } $sp1f2bf3 = new FundRecord(); $sp1f2bf3->user_id = $sp7652a3; $sp1f2bf3->type = FundRecord::TYPE_OUT; $sp1f2bf3->amount = 0; $sp1f2bf3->balance = $sp5b5487->m_balance; $sp1f2bf3->remark = $sp73594d . ', 冻结订单(' . $sp2c7393 . ')#' . $sp09599a->order_no; $sp1f2bf3->order_id = $sp09599a->id; $sp1f2bf3->saveOrFail(); } return true; }); } catch (\Throwable $sp019ea9) { $spb18c75 = 'FundHelper.orderFreeze error, user_id:' . $sp7652a3 . ',amount:' . $sp09599a->income; if ($sp09599a) { $spb18c75 .= ',order_no:' . $sp09599a->order_no; } else { $spb18c75 .= ',order_no: null'; } \Illuminate\Support\Facades\Log::error($spb18c75 . ' with exception:', array('Exception' => $sp019ea9)); return false; } } public static function orderUnfreeze($sp09599a, $spb67205, callable $sp28ab6a = null, &$spcf8eb1 = null) { $sp7652a3 = $sp09599a->user_id; try { return DB::transaction(function () use($sp09599a, $sp7652a3, $spb67205, $sp28ab6a, &$spcf8eb1) { if ($sp28ab6a !== null && $sp28ab6a() === false) { return false; } if ($sp09599a->status !== Order::STATUS_FROZEN) { $spcf8eb1 = $sp09599a->status; return true; } $sp5b5487 = User::where('id', $sp7652a3)->lockForUpdate()->firstOrFail(); if ($sp09599a->cards()->exists()) { $sp09599a->status = \App\Order::STATUS_SUCCESS; $sp5b5487->m_frozen -= $sp09599a->income; $sp5b5487->saveOrFail(); $sp1f2bf3 = new FundRecord(); $sp1f2bf3->user_id = $sp7652a3; $sp1f2bf3->type = FundRecord::TYPE_IN; $sp1f2bf3->amount = $sp09599a->income; $sp1f2bf3->balance = $sp5b5487->m_balance; $sp1f2bf3->remark = $spb67205 . ', 解冻订单#' . $sp09599a->order_no; $sp1f2bf3->order_id = $sp09599a->id; $sp1f2bf3->saveOrFail(); } else { if ($sp09599a->paid_at === NULL) { $sp09599a->status = \App\Order::STATUS_UNPAY; $sp2c7393 = '未付款'; } else { $sp09599a->status = \App\Order::STATUS_PAID; $sp2c7393 = '未发货'; } $sp1f2bf3 = new FundRecord(); $sp1f2bf3->user_id = $sp7652a3; $sp1f2bf3->type = FundRecord::TYPE_IN; $sp1f2bf3->amount = 0; $sp1f2bf3->balance = $sp5b5487->m_balance; $sp1f2bf3->remark = $spb67205 . ', 解冻订单(' . $sp2c7393 . ')#' . $sp09599a->order_no; $sp1f2bf3->order_id = $sp09599a->id; $sp1f2bf3->saveOrFail(); } $spcf8eb1 = $sp09599a->status; $sp09599a->saveOrFail(); return true; }); } catch (\Throwable $sp019ea9) { $spb18c75 = 'FundHelper.orderUnfreeze error, user_id:' . $sp7652a3 . ',amount:' . $sp09599a->income; if ($sp09599a) { $spb18c75 .= ',order_no:' . $sp09599a->order_no; } else { $spb18c75 .= ',order_no: null'; } \Illuminate\Support\Facades\Log::error($spb18c75 . ' with exception:', array('Exception' => $sp019ea9)); return false; } } }