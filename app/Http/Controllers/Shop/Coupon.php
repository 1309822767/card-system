<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp6a5e99) { $sp0e6d39 = (int) $sp6a5e99->post('category_id', -1); $spcf7e6d = (int) $sp6a5e99->post('product_id', -1); $spe16253 = $sp6a5e99->post('coupon'); if (!$spe16253) { return Response::fail('请输入优惠券'); } if ($sp0e6d39 > 0) { $sp6643b9 = Category::findOrFail($sp0e6d39); $sp9f2e5e = $sp6643b9->user_id; } elseif ($spcf7e6d > 0) { $spdbee16 = Product::findOrFail($spcf7e6d); $sp9f2e5e = $spdbee16->user_id; } else { return Response::fail('请先选择分类或商品'); } $spd94cd9 = \App\Coupon::where('user_id', $sp9f2e5e)->where('coupon', $spe16253)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spd94cd9 as $spe16253) { if ($spe16253->category_id === -1 || $spe16253->category_id === $sp0e6d39 && ($spe16253->product_id === -1 || $spe16253->product_id === $spcf7e6d)) { $spe16253->setVisible(array('discount_type', 'discount_val')); return Response::success($spe16253); } } return Response::fail('优惠券信息无效'); } }