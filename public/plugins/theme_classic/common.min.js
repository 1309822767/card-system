;var currentCategory=null;var currentProduct=null;var currentCouponInfo=null;var codeValidate=null;var shopType='shop';if(config.product&&config.product.id>0){shopType='product'}$(function(){$.ajaxSetup({xhrFields:{withCredentials:true},error:function(e,_,a){msg({title:'请求失败',content:e.responseText?JSON.parse(e.responseText).message:'网络连接错误: '+a,type:'error'})}})});function randomString(a){a=a||16;var b='ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';var c=b.length;var d='';for(var i=0;i<a;i++){d+=b.charAt(Math.floor(Math.random()*c))}return d}function getParameterByName(a,b){if(!b)b=window.location.href;a=a.replace(/[\[\]]/g,'\\{%value}');var c=new RegExp('[?&]'+a+'(=([^&#]*)|&|#|$)'),results=c.exec(b);if(!results)return null;if(!results[2])return'';return decodeURIComponent(results[2].replace(/\+/g,' '))}function renderQuill(a,b){if(!a){return''}if(typeof a==='string'){if(a[0]!=='{'){return a}try{a=JSON.parse(a)}catch(e){return a}}if(b){if(!(a.ops&&a.ops.length)){return false}if(a.ops.length===1&&a.ops[0].insert==='\n'){return false}}var c=new Quill(document.createElement('div'));c.setContents(a);return c.root.innerHTML}function selectCategory(a){if(a<=0){currentCategory=null}var b=$('#categories');if(config.theme.list_type==='button'){b.children().removeClass('checked');b.children('[data-id='+a+']').addClass('checked')}else{b.val(a)}}function selectProduct(a){if(a<=0){currentProduct=null}var b=$('#products');if(config.theme.list_type==='button'){b.children().removeClass('checked');b.children('[data-id='+a+']').addClass('checked')}else{b.val(a)}}function clearProductInfo(){currentProduct=null;currentCouponInfo=null;$('#price').html(' - ');$('#discount-btn').hide();$('#discount-tip').html('');$('#invent').html('');$('#description').html('');$('#coupon-box').hide();$('#coupon').val('');$('#should-pay').html(' - ')}function getProducts(d){if(d<1)return;selectProduct(-1);if(config.theme.list_type==='dropdown'){$('#products > option:first-child').text('加载中...')}for(var i=0;i<config.categories.length;i++){if(config.categories[i].id===+d){currentCategory=config.categories[i];break}}function showProductsHtml(b){clearProductInfo();var c=[];b.forEach(function(e){var a=document.createElement(config.theme.list_type==='button'?'div':'option');if(config.theme.list_type==='button'){a.setAttribute('class','button-select-item');a.setAttribute('data-id',e.id);a.setAttribute('onclick','productsChange('+e.id+');')}a.setAttribute('value',e.id);a.innerText=e.name;c.push(a)});if(config.theme.list_type==='button'){$('#products').html(c)}else{$('#products').html('<option value="-1">请选择商品</option>').append(c)}}if(currentCategory.products){showProductsHtml(currentCategory.products);return}var f={category_id:d};var g=function(){$.post('/api/shop/product',f).success(function(a){if(currentCategory.id!==+d){return}currentCategory.password=f.password;currentCategory.products=a.data;showProductsHtml(currentCategory.products)}).error(function(){if(config.theme.list_type==='button'){$('#products').html('')}else{$('#products').html('<option value="-1">请选择商品</option>')}selectCategory(-1)})};if(currentCategory.password_open){passwordDialog('请输入分类密码',function(a){if(!a||!a.length){showToast('warn','请输入分类密码');selectCategory(-1);if(config.theme.list_type==='button'){$('#products').html('')}else{$('#products > option:first-child').text('请选择商品')}return}f.password=a;g()})}else{g()}}function showProductInfo(c){clearProductInfo();function renderInfoToHtml(){$('#price').text((c.price/100).toFixed(2));$('#invent').html('库存: '+c.count2);$('#description').html(renderQuill(c.description)).show();if(c.price_whole){try{var a=JSON.parse(c.price_whole)}catch(e){a=[]}if(a.length){var b='';a.forEach(function(e){b+='满'+e[0]+'件，单价<b>'+(e[1]/100).toFixed(2)+'</b>元<br>'});$('#discount-btn').fadeIn();$('#discount-tip').html('<p>优惠<br>'+b+'<p>')}}if(c.support_coupon){$('#coupon-box').fadeIn()}currentProduct=c;calcTotalPrice()};if(c.password_open&&!c.password){passwordDialog('请输入商品密码',function(a){if(!a||!a.length){showToast('warn','请输入商品密码');selectProduct(-1);return}$.post('/api/shop/product/password',{product_id:c.id,password:a}).success(function(){c.password=a;renderInfoToHtml()}).error(function(){selectProduct(-1)})})}else{renderInfoToHtml()}}function getCouponInfo(){$.post('/api/shop/coupon',{category_id:currentCategory.id,product_id:currentProduct.id,coupon:$('#coupon').val()}).success(function(a){currentCouponInfo=a.data;calcTotalPrice()}).error(function(){showToast('warn','优惠券信息无效')})}function calcTotalPrice(){if(!currentProduct){$('#should-pay').html(' - ');return false}if(!assertTradeAmount()){$('#should-pay').html(' - ');return false}var a=$('#quantity').val();var b=currentProduct.price*a;try{var c=JSON.parse(currentProduct.price_whole)}catch(e){c=[]}if(c){for(var i=c.length-1;i>=0;i--){if(a>=parseInt(c[i][0])){$('#price').text((c[i][1]/100).toFixed(2));b=c[i][1]*a;break}}}var d=b;if(currentCouponInfo){var f=0;var g=1;var h=0;var j=0;if(currentCouponInfo.discount_type===f&&b>currentCouponInfo.discount_val){j=currentCouponInfo.discount_val;h=(currentCouponInfo.discount_val/100).toFixed(2)}else if(currentCouponInfo.discount_type===g){j=Math.round(d*currentCouponInfo.discount_val/100);h=currentCouponInfo.discount_val+'%'}d-=j;$('#coupon-tip').text('立减'+h+', 已优惠:'+(j/100).toFixed(2))}var k=(d/100).toFixed(2);if(1===+window.config.shop.fee_type){var l=0;var m=getPayway();if(m){l=Math.round(d*m.fee/(1-m.fee))}if(l>0){d+=l;k=(d/100).toFixed(2)+' <span style="font-size: 8px">(手续费'+(l/100).toFixed(2)+') </span>'}}$('#should-pay').html(k);return true}function assertTradeAmount(){if(!currentProduct)return;var a=$('#quantity').val();if(a<currentProduct.buy_min||currentProduct.buy_max<a){if(currentProduct.buy_min===currentProduct.buy_max){var b='此商品只能购买&nbsp;'+currentProduct.buy_min+'</b>&nbsp;件'}else{b='最少购买&nbsp;<b>'+currentProduct.buy_min+'</b>&nbsp;件<br>最多购买&nbsp;<b>'+currentProduct.buy_max+'</b>&nbsp;件'}msg({title:'提示',content:'购买数目限制<br>'+b,btn:['关闭'],then:function(){$('#quantity').val(currentProduct.buy_min).focus()}});return false}if(currentProduct.count===0){msg({title:'提示',content:'当前商品库存不足',btn:['关闭']});return false}if(+currentProduct.count&&+currentProduct.count<a){msg({title:'提示',content:'购买数目不能超出商品库存<br>当前商品库存&nbsp;<b>'+currentProduct.count+'</b>&nbsp;件',btn:['关闭'],then:function(){$('[name=quantity]').focus()}});return false}return true}var device={isQQ:function(){return navigator.userAgent.toLowerCase().indexOf('qq/')>-1},isWeChat:function(){return navigator.userAgent.toLowerCase().indexOf('micromessenger')>-1},isAlipay:function(){return navigator.userAgent.toLowerCase().indexOf('alipayclient')>-1}};function setCookie(a,b,c){if(!a||!b)return;if(c!==undefined){var d=new Date();d.setTime(d.getTime()+c);document.cookie=a+'='+encodeURI(b)+'; expires='+d.toUTCString()+'; path=/'}else{document.cookie=a+'='+encodeURI(b)+'; path=/'}}function getCookie(a){var b=('; '+document.cookie).split('; '+a+'=');if(b.length>=2)return b.pop().split(';').shift()}function getPayway(){var a=$('input[name=payway]:checked').val();if(a!==undefined){a=+a}else{return null}for(var i=0;i<config.pays.length;i++){if(config.pays[i].id===a){return config.pays[i]}}return null}function order(a){var b=$('#contact').val();if(!calcTotalPrice()){return}var c=getCookie('customer');if(!c||c.length!==32){c=randomString(32);setCookie('customer',c,24*60*60*30*1000)}var d=window.config.url+'/api/shop/buy?category_id='+currentCategory.id+'&product_id='+currentProduct.id;if(currentCategory.password)d+='&category_password='+encodeURIComponent(currentCategory.password);if(currentProduct.password)d+='&product_password='+encodeURIComponent(currentProduct.password);d+='&count='+$('#quantity').val()+'&coupon='+encodeURIComponent($('#coupon').val())+'&email='+encodeURIComponent(b)+'&pay_id='+$('input[name=payway]:checked').val()+'&customer='+c;if(window.config['vcode']['buy']){for(var e in codeValidate){if(codeValidate.hasOwnProperty(e)){d+='&'+e+'='+encodeURIComponent(codeValidate[e])}}}if(a==='self'){location.href=d;return}window.open(d,'_blank');showOrderTip('请在弹出的窗口完成付款<br><span style="font-size:13px">如果没有弹出窗口或付款失败，您也可以返回重新发起付款</span>',function(){window.open('/s#/record?tab=cookie','_blank')})}function checkOrder(){if(!currentCategory){showToast('error','请选择商品分类');$('#categories').focus();return false}if(!currentProduct){showToast('error','请选择商品');('#products').focus();return false}var a=$('#contact').val();if(!a||a.length<6){msg({type:'error',content:'联系方式长度至少为6位',then:function(){setTimeout(function(){$('#contact').focus()},500)}});return false}return calcTotalPrice()}$(function(){$('#ann>.container').html(renderQuill(config.shop.ann));if(config.shop.ann_pop){var c=renderQuill(config.shop.ann_pop,true);if(c){swal({title:'店铺公告',html:'<div class="ql-editor quill-html">'+c+'</div>'})}}var d=$('#categories');var f=$('#products');var g=[];config.categories.forEach(function(e){var a=document.createElement(config.theme.list_type==='button'?'div':'option');if(config.theme.list_type==='button'){if(shopType==='product'){a.setAttribute('class','button-select-item checked')}else{a.setAttribute('class','button-select-item');a.setAttribute('onclick','categoriesChange('+e.id+');')}a.setAttribute('data-id',e.id)}a.setAttribute('value',e.id);a.innerText=e.name;g.push(a)});if(config.theme.list_type==='button'){window.categoriesChange=function(a){d.children().removeClass('checked');d.children('[data-id='+a+']').addClass('checked');getProducts(a)};window.productsChange=function(a){f.children().removeClass('checked');f.children('[data-id='+a+']').addClass('checked');clearProductInfo();for(var i=0;i<currentCategory.products.length;i++){if(currentCategory.products[i].id===+a){showProductInfo(currentCategory.products[i]);break}}}}if(shopType==='product'){var h=document.createElement(config.theme.list_type==='button'?'div':'option');if(config.theme.list_type==='button')h.setAttribute('class','button-select-item checked');h.setAttribute('value',config.product.id);h.innerText=config.product.name;d.html(g).prop('disabled',true);currentCategory=config.categories[0];f.html(h).prop('disabled',true);config.product.password=getParameterByName('p');showProductInfo(config.product)}else{d.append(g);if(config.categories.length===1){d.val(config.categories[0].id);if(config.categories[0].password_open===false){d.prop('disabled',true)}}if(config.theme.list_type==='button'){}else{d.change(function(){currentCategory=null;clearProductInfo();getProducts($(this).val())});f.change(function(){clearProductInfo();for(var i=0;i<currentCategory.products.length;i++){if(currentCategory.products[i].id===+$(this).val()){showProductInfo(currentCategory.products[i]);break}}})}}$('#quantity').change(calcTotalPrice);$('#coupon').change(getCouponInfo);if(window.config.vcode.buy){if(window.config.vcode.driver==='geetest'){var j=window.config.vcode['geetest'];var k=document.createElement('button');k.setAttribute('id','gt-btn-verify');k.style.display='none';document.body.appendChild(k);initGeetest({gt:j.gt,challenge:j.challenge,offline:!j.success,product:'bind',width:'300px',https:true},function(b){b.onReady(function(){console.log('geetest: onReady')});b.onError(function(e){console.log('geetest: onError');console.error(e);msg({title:'出错了',content:'下单验证码加载失败, 请刷新重试',type:'error',then:function(){location.reload()}})});b.onSuccess(function(){var a=b.getValidate();if(!a){return alert('请完成验证')}codeValidate={geetest_challenge:a.geetest_challenge,geetest_validate:a.geetest_validate,geetest_seccode:a.geetest_seccode};msg({title:'验证完成',content:'验证成功，请点击按钮跳转支付页面',btn:['去支付'],then:function(){order()}})});window.captchaObj=b;$('#order-btn').click(function(){if(checkOrder()){if(typeof b.verify==='function'){b.verify()}else{$('#gt-btn-verify').click()}}});if(b.bindOn){b.bindOn('#gt-btn-verify')}})}}else{$('#order-btn').click(function(){if(checkOrder()){order()}})}});;